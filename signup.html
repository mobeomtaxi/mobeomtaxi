<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>회원가입</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif;}
body{background:#fff;color:#111;padding:18px;}

.wrap{max-width:900px;margin:0 auto;}
h2{font-size:20px;margin:6px 0 18px 0;}

.form{
  background:#fff;
  border-radius:12px;
  padding:18px;
}

.row{
  display:grid;
  grid-template-columns:140px 1fr;
  gap:14px;
  align-items:center;
  margin-bottom:14px;
}

.label{font-weight:900;color:#333;}
.req{color:#FFB121;margin-left:4px;font-weight:900;}

.control{display:flex;gap:10px;align-items:center;}

input{
  width:100%;
  padding:12px 12px;
  border:1px solid #cfd6df;
  border-radius:10px;
  font-size:14px;
  outline:none;
  background:#fff;
}
input:focus{border-color:#FFB121; box-shadow:0 0 0 3px rgba(255,177,33,0.18);}

.small{font-size:12px;color:#555;margin-top:6px;line-height:1.45;}

.btn{
  padding:11px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:900;
  border:1px solid #cfd6df;
  background:#fff;
  color:#111;
  white-space:nowrap;
}
.btn.primary{background:#FFB121;border-color:#FFB121;}
.btn.primary:hover{opacity:.92;}
.btn:disabled{opacity:.55; cursor:not-allowed;}

.msg{margin-top:6px;font-size:12px;font-weight:800;}
.msg.ok{color:#2e7d32;}
.msg.bad{color:#111;background:rgba(255,177,33,0.18);padding:6px 8px;border-radius:8px;display:inline-block;}
.msg.muted{color:#666;font-weight:700;}

.hr{height:1px;background:#eee;margin:18px 0;}

.captcha-wrap{display:flex;gap:10px;align-items:center;}
.captcha-box{
  min-width:140px;
  text-align:center;
  font-size:28px;
  font-weight:900;
  letter-spacing:3px;
  padding:10px 14px;
  background:#f3f4f6;
  border:1px solid #d7dde6;
  border-radius:10px;
  user-select:none;
}

.footer-btn{margin-top:18px;}
.footer-btn .big{
  width:100%;
  padding:16px;
  border-radius:12px;
  font-size:18px;
  font-weight:900;
  border:0;
  background:#FFB121;
  cursor:pointer;
}
.footer-btn .big:hover{opacity:.92;}
.footer-btn .big:disabled{opacity:.55; cursor:not-allowed;}

@media (max-width:720px){
  .row{grid-template-columns:1fr; gap:6px;}
}
</style>
</head>
<body>
<div class="wrap">
  <h2>회원가입</h2>

  <div class="form">

    <!-- 아이디 -->
    <div class="row">
      <div class="label">아이디 <span class="req">*</span></div>
      <div>
        <div class="control">
          <input id="userId" type="text" placeholder="아이디" autocomplete="username" />
          <button id="checkBtn" class="btn" type="button" onclick="checkId()">중복체크</button>
        </div>
        <div id="idMsg" class="msg"></div>
      </div>
    </div>

    <!-- 비번 -->
    <div class="row">
      <div class="label">비밀번호 <span class="req">*</span></div>
      <div>
        <input id="pw" type="password" placeholder="비밀번호" autocomplete="new-password" />
        <div class="small">비밀번호는 최소 <b>10자 이상</b> 입력하세요.</div>
        <div id="pwMsg" class="msg"></div>
      </div>
    </div>

    <!-- 비번확인 -->
    <div class="row">
      <div class="label">비밀번호 확인 <span class="req">*</span></div>
      <div>
        <input id="pw2" type="password" placeholder="비밀번호 확인" autocomplete="new-password" />
        <div id="pw2Msg" class="msg"></div>
      </div>
    </div>

    <!-- 닉네임 -->
    <div class="row">
      <div class="label">닉네임 <span class="req">*</span></div>
      <div>
        <input id="nick" type="text" placeholder="닉네임" />
        <div class="small">공백없이 한글/영문/숫자만 입력 가능</div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- 이메일 -->
    <div class="row">
      <div class="label">이메일 <span class="req">*</span></div>
      <div><input id="email" type="email" placeholder="이메일" autocomplete="email" /></div>
    </div>

    <!-- 휴대폰 -->
    <div class="row">
      <div class="label">휴대폰 <span class="req">*</span></div>
      <div class="control">
        <input id="phone" type="text" placeholder="휴대폰 번호(- 포함)" autocomplete="tel" />
        <button class="btn" type="button" onclick="alert('휴대폰 인증은 추후 연결')">인증번호 발송</button>
      </div>
    </div>

    <!-- 한줄소개 -->
    <div class="row">
      <div class="label">한줄 소개 <span class="req">*</span></div>
      <div><input id="intro" type="text" placeholder="한줄 소개 (20자 이내)" maxlength="20" /></div>
    </div>

    <div class="hr"></div>

    <!-- 추천인 -->
    <div class="row">
      <div class="label">추천인</div>
      <div><input id="ref" type="text" placeholder="추천인 아이디(없으면 비워두세요)" /></div>
    </div>

    <!-- 캡차 -->
    <div class="row">
      <div class="label">자동등록방지 <span class="req">*</span></div>
      <div>
        <div class="captcha-wrap">
          <div class="captcha-box" id="captchaText"></div>
          <button class="btn" type="button" onclick="generateCaptcha()">↻</button>
        </div>
        <div style="margin-top:10px;">
          <input id="captchaInput" type="text" placeholder="자동등록방지 문자 입력" />
          <div id="captchaMsg" class="msg"></div>
        </div>
      </div>
    </div>

    <div class="footer-btn">
      <button id="signupBtn" class="big" type="button" onclick="submitSignup()">회원가입</button>
      <div id="signupMsg" class="msg muted" style="margin-top:10px;"></div>
    </div>

  </div>
</div>

<script>
/**
 * ✅ 중요: API 경로는 항상 절대경로로!
 * - iframe 안에서 상대경로 쓰면 /signup.html/api/signup 같은 식으로 꼬일 수 있음
 */
const API = {
  checkUsername: "/api/check-username",
  signup: "/api/signup",
};

let idChecked = false;
let idOk = false;

function setMsg(el, text, type){
  el.textContent = text || "";
  el.className = "msg " + (type || "");
}

function lockUI(locked){
  const btn1 = document.getElementById("checkBtn");
  const btn2 = document.getElementById("signupBtn");
  btn1.disabled = locked;
  btn2.disabled = locked;
}

async function checkId(){
  const id = document.getElementById("userId").value.trim();
  const msg = document.getElementById("idMsg");

  idChecked = true;
  idOk = false;

  if(!id){
    setMsg(msg, "아이디를 입력하세요.", "bad");
    return;
  }
  if(id.length < 3){
    setMsg(msg, "아이디는 3자 이상 입력하세요.", "bad");
    return;
  }

  setMsg(msg, "확인 중...", "muted");
  lockUI(true);

  try{
    // 1) GET 시도: /api/check-username?username=...
    let r = await fetch(`${API.checkUsername}?username=${encodeURIComponent(id)}`, {
      method: "GET",
      headers: { "Accept": "application/json" },
    });

    // 2) 혹시 GET이 막혀있으면 POST로 재시도
    if(r.status === 405 || r.status === 404){
      r = await fetch(API.checkUsername, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept":"application/json" },
        body: JSON.stringify({ username: id }),
      });
    }

    const data = await r.json().catch(()=> ({}));

    // 기대값: { ok:true, available:true/false } 또는 { ok:true, exists:true/false }
    const available = (data.available === true) || (data.exists === false);
    const taken = (data.available === false) || (data.exists === true);

    if(!r.ok){
      setMsg(msg, data.msg || "중복체크 실패(서버)", "bad");
      idOk = false;
      return;
    }

    if(taken){
      setMsg(msg, "이미 사용 중인 아이디입니다.", "bad");
      idOk = false;
      return;
    }

    // unknown이면 안전하게 available로만 인정
    if(available || data.ok === true){
      idOk = true;
      setMsg(msg, "사용 가능한 아이디입니다.", "ok");
      return;
    }

    setMsg(msg, "중복체크 응답을 확인할 수 없습니다.", "bad");
    idOk = false;
  }catch(e){
    setMsg(msg, "중복체크 실패(네트워크/서버)", "bad");
    idOk = false;
  }finally{
    lockUI(false);
  }
}

// 아이디 바꾸면 다시 체크 필요
document.getElementById("userId").addEventListener("input", ()=>{
  idChecked = false;
  idOk = false;
  document.getElementById("idMsg").textContent = "";
});

// 비밀번호 실시간 체크
document.getElementById("pw").addEventListener("input", ()=>{
  const pw = document.getElementById("pw").value;
  const pwMsg = document.getElementById("pwMsg");
  if(!pw) { pwMsg.textContent=""; return; }
  if(pw.length < 10) setMsg(pwMsg, "비밀번호는 10자 이상이어야 합니다.", "bad");
  else setMsg(pwMsg, "좋아요.", "ok");
  checkPwMatch();
});
document.getElementById("pw2").addEventListener("input", checkPwMatch);

function checkPwMatch(){
  const pw = document.getElementById("pw").value;
  const pw2 = document.getElementById("pw2").value;
  const el = document.getElementById("pw2Msg");
  if(!pw2){ el.textContent=""; return; }
  if(pw !== pw2) setMsg(el, "비밀번호가 일치하지 않습니다.", "bad");
  else setMsg(el, "비밀번호가 일치합니다.", "ok");
}

/* 캡차 */
let captcha = "";
function generateCaptcha(){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ2345678923456789";
  captcha = "";
  for(let i=0;i<6;i++){
    captcha += chars[Math.floor(Math.random()*chars.length)];
  }
  document.getElementById("captchaText").textContent = captcha;
  document.getElementById("captchaInput").value = "";
  document.getElementById("captchaMsg").textContent = "";
}
generateCaptcha();

async function submitSignup(){
  const signupMsg = document.getElementById("signupMsg");
  signupMsg.textContent = "";

  const username = document.getElementById("userId").value.trim();
  const password = document.getElementById("pw").value;
  const password2 = document.getElementById("pw2").value;
  const nickname = document.getElementById("nick").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const intro = document.getElementById("intro").value.trim();
  const recommender = document.getElementById("ref").value.trim();
  const cap = document.getElementById("captchaInput").value.trim();
  const capMsg = document.getElementById("captchaMsg");

  if(!username){ alert("아이디를 입력하세요."); return; }
  if(!idChecked || !idOk){ alert("아이디 중복체크를 완료하세요."); return; }

  if(!password || password.length < 10){ alert("비밀번호는 10자 이상이어야 합니다."); return; }
  if(password !== password2){ alert("비밀번호가 일치하지 않습니다."); return; }

  if(!nickname){ alert("닉네임을 입력하세요."); return; }
  if(!email){ alert("이메일을 입력하세요."); return; }
  if(!phone){ alert("휴대폰 번호를 입력하세요."); return; }
  if(!intro){ alert("한줄 소개를 입력하세요."); return; }

  if(cap.toUpperCase() !== captcha){
    setMsg(capMsg, "자동등록방지 문자가 올바르지 않습니다.", "bad");
    generateCaptcha();
    return;
  }

  lockUI(true);
  signupMsg.textContent = "회원가입 처리 중...";

  try{
    const r = await fetch(API.signup, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json",
      },
      body: JSON.stringify({
        username,
        password,
        nickname,
        email,
        phone,
        intro,
        recommender: recommender || null,
      }),
    });

    const data = await r.json().catch(()=> ({}));

    if(r.ok && data.ok){
      alert("회원가입 완료!");
      if(window.parent && typeof window.parent.closeSignup === "function"){
        window.parent.closeSignup();
      }
      return;
    }

    // 서버가 msg 내려주면 그대로 표시
    const msg = data.msg || `회원가입 실패(HTTP ${r.status})`;
    alert(msg);

    // 아이디 중복이면 다시 체크 유도
    if(r.status === 409){
      idChecked = false; idOk = false;
      setMsg(document.getElementById("idMsg"), "중복체크를 다시 해주세요.", "bad");
    }

  }catch(e){
    alert("회원가입 실패(서버 응답 오류)");
  }finally{
    signupMsg.textContent = "";
    lockUI(false);
  }
}
</script>
</body>
</html>
